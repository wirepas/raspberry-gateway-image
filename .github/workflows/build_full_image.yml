# This is a workflow to build image with pi-gen tool

name: Build Full Rpi image from scratch

on:
  pull_request:
  
  workflow_dispatch:

jobs:
  build_image:
    runs-on: ubuntu-latest
    #container:
    #  image: i386/debian:buster

    steps:
    #  - name: add git repo for recent version
    #    run: |
    #      apt-get -y update
    #      apt-get -y install software-properties-common
    #      add-apt-repository ppa:git-core/ppa
          
    #  - name: install required package
    #    run: |
    #      apt-get -y update
    #      apt-get -y install coreutils quilt parted qemu-user-static debootstrap zerofree zip \
    #             dosfstools bsdtar libcap2-bin grep rsync xz-utils file git curl bc \
    #             qemu-utils kpartx xxd kmod
                 
    #  - name: check git version
    #    run: git --version
                 
      - name: checkout our repo
        uses: actions/checkout@v2
        
      - name: checkout pi-gen
        uses: actions/checkout@v2
        with:
          repository: 'RPi-Distro/pi-gen'
          ref: '2021-05-07-raspbian-buster'
          path: 'pi-gen'
             
      - name: Copy our own sub step
        run: |
          cp -r step/04-install-docker pi-gen/stage2/
          chmod a+x pi-gen/stage2/04-install-docker/00-run.sh
     
      - name: create config
        run: |
           touch config
           echo "IMG_NAME='Raspbian_Test'" >> config
           echo "ENABLE_SSH=1" >> config
           echo "TARGET_HOSTNAME='wirepasgw'" >> config
           echo "FIRST_USER_NAME='wirepas'" >> config
           echo "FIRST_USER_PASS='wirepass'" >> config
           echo "STAGE_LIST=\"stage0 stage1 stage2\"" >> config
        working-directory: pi-gen
           
      - name: check config
        run: cat config
        working-directory: pi-gen
        
      - name: run script with docker
        run: ./build-docker.sh 
        working-directory: pi-gen
           
           
