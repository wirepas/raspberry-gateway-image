# This is a workflow to build image with pi-gen tool

name: Build Full Rpi image from scratch

on:
  pull_request:
  
  workflow_dispatch:

jobs:
  build_image:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:xenial

    steps:
      - name: checkout our repo
        uses: actions/checkout@v2
        
      - name: checkout pi-gen
        uses: actions/checkout@v2
        with:
          repository: 'RPi-Distro/pi-gen'
          ref: '2021-05-07-raspbian-buster'
          path: 'pi-gen'
             
      - name: Nothing yet
        run: ls
        
      - name: install required package
        run: |
          apt-get -y update
          apt-get -y install coreutils quilt parted qemu-user-static debootstrap zerofree zip \
                 dosfstools bsdtar libcap2-bin grep rsync xz-utils file git curl bc \
                 qemu-utils kpartx
     
      - name: create config
        run: |
           touch myconfig
           echo "IMG_NAME='Raspbian_Test'" >> myconfig
           echo "ENABLE_SSH=1" >> myconfig
           echo "TARGET_HOSTNAME='wirepasgw'" >> myconfig
           echo "FIRST_USER_NAME='wirepas'" >> myconfig
           echo "FIRST_USER_PASS='wirepass'" >> myconfig
           echo "STAGE_LIST=\"stage0 stage1 stage2\"" >> myconfig
           
      - name: check config
        run: cat myconfig
        
      - name: run script
        run: ./build.sh -c ../myconfig
        working-directory: pi-gen
           
           
